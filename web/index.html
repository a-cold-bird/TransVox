<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Video Translate UI</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif; margin: 20px; }
    .card { max-width: 900px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,.05); }
    h1 { margin-top: 0; }
    label { display: block; margin: 12px 0 6px; font-weight: 600; }
    input[type="text"], select { width: 100%; padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 6px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .btn { background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 10px 14px; cursor: pointer; margin-top: 12px; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .result { margin-top: 20px; white-space: pre-wrap; background: #f9fafb; padding: 12px; border-radius: 6px; border: 1px solid #e5e7eb; }
    .hint { color: #6b7280; font-size: 12px; }
    details { margin-top: 12px; }
    textarea { width: 100%; min-height: 200px; font-family: monospace; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px; resize: both; }
    video { width: 100%; max-height: 320px; background: #000; border-radius: 6px; }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid #fff; border-top-color:transparent; border-radius:50%; margin-left:8px; animation: spin .8s linear infinite; vertical-align: middle; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast { position: fixed; right: 16px; top: 16px; z-index: 9999; background: #10b981; color: #fff; padding: 10px 14px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,.15); display:none; }
    .toast .close { background: transparent; border: none; color: #fff; font-weight: bold; margin-left: 10px; cursor: pointer; }
    .glass { position: fixed; right: 16px; top: 12px; width: 340px; z-index: 10000; padding: 8px 10px; border-radius: 10px; background: rgba(255,255,255,0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); box-shadow: 0 6px 22px rgba(0,0,0,.10); border: 1px solid rgba(255,255,255,0.45); }
    .glass .close { position: absolute; top: 6px; right: 8px; background: transparent; border: none; font-size: 13px; cursor: pointer; color: #111827; }
    .guide.glass { top: 92px; }
    .md { font-size: 12px; line-height: 1.35; color: #111827; }
    .md h2 { margin: 2px 0 2px; font-size: 12px; font-weight: 700; }
    .md p { margin: 1px 0; }
    .md ul { margin: 2px 0 2px 14px; padding: 0; }
    .md li { margin: 0; }
    
    /* è§†é¢‘å†å²æ ·å¼ */
    .video-item { border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin: 12px 0; background: #f9fafb; }
    .video-item h3 { margin: 0 0 8px 0; font-size: 16px; color: #111827; }
    .video-info { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0; font-size: 14px; color: #6b7280; }
    .video-actions { display: flex; gap: 8px; margin-top: 12px; }
    .video-actions .btn { padding: 6px 12px; font-size: 14px; }
    .video-actions .btn-danger { background: #dc2626; }
    .video-actions .btn-danger:hover { background: #b91c1c; }
    .video-preview { width: 100%; max-width: 300px; height: 200px; background: #000; border-radius: 6px; margin: 8px 0; }
    .srt-links { margin: 8px 0; }
    .srt-links a { color: #2563eb; text-decoration: none; margin-right: 12px; font-size: 14px; }
    .srt-links a:hover { text-decoration: underline; }
    .empty-history { text-align: center; color: #6b7280; padding: 40px; }
  </style>
  <script>
    let CURRENT_JOB = null; let CURRENT_USER = null; let PROGRESS_TIMER = null; let PRESET_VIDEO_PATH = null;
    let VIDEO_LIMITS = { max_video_minutes: 20, max_video_bytes: 1024 * 1024 * 1024, max_video_mb: 1024 };
    let CURRENT_FILE_VALID = false; // å½“å‰æ–‡ä»¶æ˜¯å¦é€šè¿‡éªŒè¯
    
    // é‡ç½®æŒ‰é’®çŠ¶æ€çš„é€šç”¨å‡½æ•°
    function resetButtonState(btn, oldText, outBox) {
      btn.disabled = false;
      btn.textContent = oldText;
      // ç§»é™¤spinner
      const spinner = btn.querySelector('.spinner');
      if (spinner) spinner.remove();
      if (outBox) outBox.style.display = 'none';
    }
    
    // åŠ è½½è§†é¢‘é™åˆ¶é…ç½®
    async function loadVideoLimits() {
      try {
        const response = await fetch('/limits');
        const limits = await response.json();
        if (limits.max_video_minutes && limits.max_video_bytes) {
          VIDEO_LIMITS = limits;
          console.log('å·²åŠ è½½è§†é¢‘é™åˆ¶é…ç½®:', VIDEO_LIMITS);
        }
      } catch (e) {
        console.warn('åŠ è½½è§†é¢‘é™åˆ¶é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', e);
      }
    }
    
    async function loadSRT(stem) {
      const out = document.getElementById('output');
      try {
        const params = new URLSearchParams();
        params.set('stem', stem);
        if (CURRENT_USER) params.set('user_id', CURRENT_USER);
        if (CURRENT_JOB) params.set('job_id', CURRENT_JOB);
        const res = await fetch(`/srt?${params.toString()}`);
        const json = await res.json();
        if (json.content !== undefined) {
          document.getElementById('srt_stem').value = stem;
          document.getElementById('srt_content').value = json.content;
          document.getElementById('srt_box').open = true;
        } else {
          out.textContent = JSON.stringify(json, null, 2);
        }
      } catch (err) {
        out.textContent = 'åŠ è½½SRTå¤±è´¥: ' + err;
      }
    }
    async function saveSRT() {
      const stem = document.getElementById('srt_stem').value.trim();
      const content = document.getElementById('srt_content').value;
      const out = document.getElementById('output');
      if (!stem) { out.textContent = 'ç¼ºå°‘è§†é¢‘æ ‡è¯†(stem)ã€‚'; return; }
      const form = new FormData();
      form.append('stem', stem);
      form.append('content', content);
      if (CURRENT_USER) form.append('user_id', CURRENT_USER);
      if (CURRENT_JOB) form.append('job_id', CURRENT_JOB);
      try {
        const res = await fetch('/srt/save', { method: 'POST', body: form });
        const json = await res.json();
        out.textContent = JSON.stringify(json, null, 2);
        // ä¿å­˜åç«‹å³åˆ·æ–°æœ€æ–°å†…å®¹ï¼ˆé¿å…å‘½åç©ºé—´/legacyä¸åŒæ­¥å¯¼è‡´æœªæ›´æ–°ï¼‰
        await loadSRT(stem);
      } catch (err) { out.textContent = 'ä¿å­˜SRTå¤±è´¥: ' + err; }
    }
    async function continueTTS() {
      const out = document.getElementById('output');
      const stem = document.getElementById('srt_stem').value.trim();
      const ttsEngine = document.getElementById('tts_engine').value;
      const textLang = document.getElementById('target_lang').value;
      const srcLang = document.getElementById('source_lang').value;
      const speedFactorStr = document.getElementById('speed_factor').value.trim();
      if (!stem) { out.textContent = 'è¯·å…ˆåŠ è½½æˆ–å¡«å†™è§†é¢‘æ ‡è¯†(stem)ã€‚'; return; }
      const form = new FormData();
      form.append('stem', stem);
      if (CURRENT_USER && CURRENT_JOB) { form.append('user_id', CURRENT_USER); form.append('job_id', CURRENT_JOB); }
      form.append('tts_engine', ttsEngine);
      form.append('text_lang', textLang);
      form.append('source_lang', srcLang);
      form.append('prompt_lang', srcLang); // ä½¿ç”¨æºè¯­è¨€ä½œä¸ºprompt_lang
      if (ttsEngine === 'gpt-sovits' && speedFactorStr) form.append('speed_factor', speedFactorStr);
      try {
        const res = await fetch('/continue_tts', { method: 'POST', body: form });
        const json = await res.json(); const outBox = document.getElementById('output'); outBox.style.display = 'block'; outBox.textContent = JSON.stringify(json, null, 2);
        if (json && json.final_video) {
          const path = String(json.final_video).replace(/\\/g,'/').replace(/\\/g,'/');
          const i = path.indexOf('/output/'); if (i >= 0) { const rel = path.slice(i); const wrap = document.getElementById('final_wrap'); const v = document.getElementById('final_preview'); const dl = document.getElementById('final_download'); v.src = rel; wrap.style.display = 'block'; dl.href = rel; localStorage.setItem('final_preview_path', rel); localStorage.removeItem('final_hidden'); showToast('å·²å®Œæˆ TTS åˆå¹¶'); loadVideoHistory(); stopAutoRefresh(); }
        }
      } catch (err) { showToast('ç»§ç»­TTSå¤±è´¥'); stopAutoRefresh(); }
    }
    function setTargetLangOptions(tts) { const sel = document.getElementById('target_lang'); const current = sel.value; while (sel.firstChild) sel.removeChild(sel.firstChild); const langs = tts === 'gpt-sovits' ? ['zh','en','ja','ko'] : ['zh','en']; langs.forEach(l => { const opt = document.createElement('option'); opt.value = l; opt.textContent = l; sel.appendChild(opt); }); if (langs.includes(current)) sel.value = current; }
    function onTTSEngineChange() { const tts = document.getElementById('tts_engine').value; setTargetLangOptions(tts); const speedWrap = document.getElementById('speed_wrap'); speedWrap.style.display = (tts === 'gpt-sovits') ? 'block' : 'none'; }
    function deriveStemFromPath(p) { if (!p) return ''; const parts = p.replace(/\\/g,'/').split('/'); const name = parts[parts.length-1] || ''; const dot = name.lastIndexOf('.'); return dot > 0 ? name.slice(0, dot) : name; }
    async function submitForm(e) {
      e.preventDefault(); const btn = document.getElementById('submitBtn'); const out = document.getElementById('output');
      btn.disabled = true; const old = btn.textContent; btn.textContent = 'å¤„ç†ä¸­...'; btn.insertAdjacentHTML('beforeend', '<span class="spinner"></span>'); const outBox = document.getElementById('output'); outBox.style.display = 'block'; outBox.textContent = 'è¯·æ±‚ä¸­...';
      const form = new FormData();
      const file = document.getElementById('file').files[0]; const sourceLang = document.getElementById('source_lang').value; const targetLang = document.getElementById('target_lang').value; const ttsEngine = document.getElementById('tts_engine').value; const transcribeEngine = document.getElementById('transcribe_engine').value; const diarization = document.getElementById('diarization').checked; const separation = document.getElementById('separation').checked; const speedFactorStr = document.getElementById('speed_factor').value.trim(); const skipTTS = document.getElementById('skip_tts').checked;
      if (!file && !PRESET_VIDEO_PATH) { 
        showToast('è¯·ä¸Šä¼ è§†é¢‘æˆ–åŠ è½½é¢„è®¾'); 
        resetButtonState(btn, old, outBox);
        return; 
      }
      
      // æ£€æŸ¥ä¸Šä¼ æ–‡ä»¶çš„éªŒè¯çŠ¶æ€
      if (file && !CURRENT_FILE_VALID) {
        showToast('è¯·é€‰æ‹©ç¬¦åˆé™åˆ¶è¦æ±‚çš„è§†é¢‘æ–‡ä»¶\nå½“å‰æ–‡ä»¶è¶…å‡ºå¤§å°æˆ–æ—¶é•¿é™åˆ¶');
        resetButtonState(btn, old, outBox);
        return;
      }
      if (file) { document.getElementById('srt_stem').value = deriveStemFromPath(file.name); form.append('file', file); const url = URL.createObjectURL(file); const v = document.getElementById('upload_preview'); const w = document.getElementById('upload_wrap'); v.src = url; w.style.display = 'block'; localStorage.setItem('upload_preview_type', 'blob'); localStorage.setItem('upload_preview_name', file.name); }
      else if (PRESET_VIDEO_PATH) { document.getElementById('srt_stem').value = deriveStemFromPath(PRESET_VIDEO_PATH); form.append('video_path', PRESET_VIDEO_PATH); const v = document.getElementById('upload_preview'); const w = document.getElementById('upload_wrap'); const rel = '/'+PRESET_VIDEO_PATH.replace(/\\/g,'/'); v.src = rel; w.style.display = 'block'; localStorage.setItem('upload_preview_type', 'preset'); localStorage.setItem('upload_preview_path', rel); }
      form.append('source_lang', sourceLang); form.append('target_lang', targetLang); form.append('tts_engine', ttsEngine); form.append('transcribe_engine', transcribeEngine); form.append('diarization', String(diarization)); form.append('separation', String(separation)); if (ttsEngine === 'gpt-sovits' && speedFactorStr !== '') { const f2 = Number(speedFactorStr); if (!Number.isNaN(f2)) form.append('speed_factor', String(f2)); } form.append('skip_tts', String(skipTTS));
      try {
        try { const who = await fetch('/whoami'); const whoj = await who.json(); CURRENT_USER = whoj.user_id; document.getElementById('user_id').textContent = CURRENT_USER || '-'; document.getElementById('queue_len').textContent = String(whoj.queue_len ?? 0); } catch (e) {}
        const res = await fetch('/process', { method: 'POST', body: form }); const json = await res.json(); outBox.textContent = JSON.stringify(json, null, 2);
        if (json && json.status === 'queued') { showToast('å·²åŠ å…¥é˜Ÿåˆ—'); CURRENT_JOB = json.data && json.data.job_id ? json.data.job_id : null; if (CURRENT_JOB) startProgressPolling(CURRENT_JOB); startAutoRefresh(); }
        if (json && json.status === 'failed') { showToast('ä»»åŠ¡å¤±è´¥'); stopAutoRefresh(); }
        if (json && json.error) { 
          // æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
          let errorMsg = json.error;
          if (json.file_size && json.max_size) {
            errorMsg += `\næ–‡ä»¶å¤§å°: ${json.file_size.toFixed(1)}MB / é™åˆ¶: ${json.max_size.toFixed(1)}MB`;
          }
          if (json.duration && json.max_duration) {
            errorMsg += `\nè§†é¢‘æ—¶é•¿: ${json.duration.toFixed(1)}åˆ†é’Ÿ / é™åˆ¶: ${json.max_duration}åˆ†é’Ÿ`;
          }
          if (json.suggestion) {
            errorMsg += `\nå»ºè®®: ${json.suggestion}`;
          }
          showToast(errorMsg);
        }
        if (json && json.data && json.data.final_video) { const path = String(json.data.final_video).replace(/\\/g,'/').replace(/\\/g,'/'); const i = path.indexOf('/output/'); if (i >= 0) { const rel = path.slice(i); const wrap = document.getElementById('final_wrap'); const v = document.getElementById('final_preview'); const dl = document.getElementById('final_download'); v.src = rel; wrap.style.display = 'block'; dl.href = rel; localStorage.setItem('final_preview_path', rel); localStorage.removeItem('final_hidden'); showToast('å¤„ç†å®Œæˆ'); loadVideoHistory(); stopAutoRefresh(); } }
        if (skipTTS && json && json.data && json.data.video_stem) { const box = document.getElementById('srt_box'); box.style.display = 'block'; /* ç”±è½®è¯¢åœ¨ç”Ÿæˆåè‡ªåŠ¨åŠ è½½SRT */ }
      } catch (err) { showToast('è¯·æ±‚å¤±è´¥'); stopAutoRefresh(); }
      finally { 
        resetButtonState(btn, old, outBox);
      }
    }
    function startProgressPolling(jobId) { stopProgressPolling(); PROGRESS_TIMER = setInterval(async () => { try { const res = await fetch(`/progress?job_id=${encodeURIComponent(jobId)}`); if (!res.ok) return; const j = await res.json(); const p = Math.max(0, Math.min(100, Number(j.progress || 0))); const bar = document.getElementById('progress_bar'); const text = document.getElementById('progress_text'); bar.style.width = `${p}%`; text.textContent = `${p}% ${j.step || ''}`; // å½“ç¿»è¯‘å®Œæˆæˆ–ä»»åŠ¡å®Œæˆæ—¶å°è¯•åŠ è½½ translated.srt
          if (j && j.data && j.data.video_stem) {
            const stem = j.data.video_stem;
            // è‹¥å·²ç”Ÿæˆ translated_srt æˆ–çŠ¶æ€å®Œæˆï¼Œåˆ™åŠ è½½ä¸€æ¬¡ä»¥åˆ·æ–°ç¼–è¾‘åŒº
            if ((j.data.translated_srt) || j.status === 'succeeded') {
              await loadSRT(stem);
            }
          }
          if (j.status === 'succeeded' || j.status === 'failed' || j.status === 'cancelled') { stopProgressPolling(); showToast(j.status === 'succeeded' ? 'å¤„ç†å®Œæˆ' : (j.status === 'cancelled' ? 'å·²å–æ¶ˆ' : 'å¤±è´¥')); if (j.status === 'succeeded') { loadVideoHistory(); } stopAutoRefresh(); } } catch (e) {} }, 800); }
    function stopProgressPolling() { if (PROGRESS_TIMER) clearInterval(PROGRESS_TIMER); PROGRESS_TIMER = null; }
    async function cancelJob() { if (!CURRENT_JOB) { showToast('æš‚æ— å¯å–æ¶ˆçš„ä»»åŠ¡'); return; } try { const r = await fetch('/cancel', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `job_id=${encodeURIComponent(CURRENT_JOB)}` }); const jr = await r.json(); if (r.ok) { showToast('å·²è¯·æ±‚å–æ¶ˆ'); } else { showToast(jr.error || 'å–æ¶ˆå¤±è´¥'); } } catch(e) { showToast('å–æ¶ˆå¤±è´¥'); } }
    function showToast(msg){ 
      const t = document.getElementById('toast'); 
      // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºHTMLæ¢è¡Œ
      const formattedMsg = msg.replace(/\n/g, '<br>');
      t.innerHTML = `<span>${formattedMsg}</span><button class="close" onclick="hideToast()">Ã—</button>`; 
      t.style.display = 'block'; 
      // å¦‚æœæ˜¯é”™è¯¯ä¿¡æ¯ï¼Œè®¾ç½®æ›´é•¿çš„æ˜¾ç¤ºæ—¶é—´
      if (msg.includes('è¿‡å¤§') || msg.includes('è¿‡é•¿') || msg.includes('å¤±è´¥')) {
        setTimeout(() => hideToast(), 8000); // 8ç§’åè‡ªåŠ¨éšè—
      }
    }
    function hideToast(){ const t = document.getElementById('toast'); t.style.display = 'none'; }
  </script>
  </head>
  <body>
    <div class="card">
      <h1>Video Translate UI (åŒå£°ç¿»è¯‘UI)</h1>
      <div id="notice" class="glass" style="display:block;">
        <button class="close" onclick="document.getElementById('notice').style.display='none'">Ã—</button>
        <div id="notice_md" class="md"></div>
      </div>
      <p class="hint">è¯´æ˜ï¼šä¸Šä¼ ä¸€ä¸ªè§†é¢‘æ–‡ä»¶ï¼Œå®Œæˆè½¬å†™/ç¿»è¯‘/åˆæˆæµç¨‹ã€‚</p>
      <p class="hint">æ”¯æŒè¯­è¨€ï¼šä¸­æ–‡ã€è‹±æ–‡ã€æ—¥æ–‡ã€éŸ©æ–‡</p>
      <p class="hint">æ”¯æŒå¼•æ“ï¼šindextts2(æ¯”è¾ƒæ…¢ã€åªæ”¯æŒä¸­è‹±,ä½†æ˜¯æ•ˆæœè¿˜å¯ä»¥)ã€gpt-sovits(æ”¯æŒä¸­æ—¥è‹±éŸ©)</p>
      <p class="hint">æ”¯æŒå¯¹ç¿»è¯‘åçš„å­—å¹•æ–‡ä»¶è¿›è¡Œæ‰‹åŠ¨ä¿®æ”¹å†è¿›è¡Œç”Ÿæˆ</p>
      <p class="hint">å› ä¸ºæ•´ä¸ªæµç¨‹æ‰€èŠ±è´¹çš„æ—¶é—´å’Œè§†é¢‘æ—¶é—´å·®ä¸å¤šï¼Œæ‰€ä»¥ä¸ºäº†é˜²æ­¢å¤šäººä½¿ç”¨æ—¶é€ æˆç”¨æˆ·æ‹¥å µ</p>
      <p class="hint">æš‚æ—¶å°†zè§†é¢‘é™åˆ¶åˆ°æœ€é•¿5åˆ†é’Ÿï¼Œå¹¶ä¸”ç”Ÿæˆè¿‡ç¨‹ä¸­è¯·è€å¿ƒç­‰å¾…</p>
      <div class="row">
        <div>ç”¨æˆ·IDï¼š<span id="user_id">-</span></div>
        <div>æ’é˜Ÿäººæ•°ï¼š<span id="queue_len">0</span></div>
      </div>
      <div style="margin:8px 0; background:#e5e7eb; height:10px; border-radius:6px; position:relative;">
        <div id="progress_bar" style="position:absolute; left:0; top:0; bottom:0; width:0%; background:#22c55e; border-radius:6px;"></div>
      </div>
      <div id="progress_text" class="hint">0%</div>
      <form onsubmit="submitForm(event)">
        <button class="btn" type="button" id="preset_btn">åŠ è½½é¢„è®¾ (ZH_test.mp4 | gpt-sovits | whisperx)</button>
        <label>ä¸Šä¼ è§†é¢‘æ–‡ä»¶</label>
        <div id="drop_zone" style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 20px; text-align: center; background: #f9fafb; margin: 8px 0; cursor: pointer; transition: all 0.2s;">
          <div id="drop_text">æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
          <div id="file_info" style="margin-top: 8px; font-size: 12px; color: #6b7280; display: none;"></div>
          <div id="file_status" style="margin-top: 4px; font-size: 11px; display: none;"></div>
          <input id="file" type="file" accept="video/*" style="display: none;" onchange="handleFileSelect(event)" />
        </div>
        <div id="upload_wrap" style="margin-top:8px; display:none; position:relative;">
          <video id="upload_preview" controls></video>
          <button type="button" class="btn" style="position:absolute; top:4px; right:4px; padding:4px 8px;" onclick="removeUpload()">Ã—</button>
        </div>

        <div class="row">
          <div>
            <label>TTS å¼•æ“</label>
            <select id="tts_engine" onchange="onTTSEngineChange()">
              <option value="indextts" selected>indextts</option>
              <option value="gpt-sovits">gpt-sovits</option>
            </select>
            <p class="hint">indextts ä»…æ”¯æŒ zh/enï¼›gpt-sovits æ”¯æŒ zh/en/ja/ko</p>
          </div>
          <div>
            <label>è½¬å†™å¼•æ“</label>
            <select id="transcribe_engine">
              <option value="whisperx" selected>whisperx</option>
              <!-- <option value="funclip">funclip</option> -->
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>è¾“å…¥è¯­è¨€</label>
            <select id="source_lang">
              <option value="auto" selected>auto</option>
              <option value="zh">zh</option>
              <option value="en">en</option>
              <option value="ja">ja</option>
              <option value="ko">ko</option>
            </select>
          </div>
          <div>
            <label>è¾“å‡ºè¯­è¨€ï¼ˆå¿…é€‰ï¼‰</label>
            <select id="target_lang">
              <option value="zh">zh</option>
              <option value="en" selected>en</option>
              <option value="ja">ja</option>
              <option value="ko">ko</option>
            </select>
          </div>
        </div>

        <div id="speed_wrap" style="display:none;">
          <label>è¯­é€Ÿ (ä»… gpt-sovits)</label>
          <input id="speed_factor" type="number" step="0.05" min="0.5" max="2.0" placeholder="ä¾‹å¦‚ 1.2 (å¯é€‰)" />
          <p class="hint">>1.0 åŠ å¿«ï¼›<1.0 å˜æ…¢ï¼›ç•™ç©ºä½¿ç”¨é»˜è®¤è¯­é€Ÿ</p>
        </div>

        <label><input id="skip_tts" type="checkbox" onchange="onSkipTTSChange()" /> åªç”Ÿæˆç¿»è¯‘ï¼Œä¸è¿›è¡ŒTTSï¼ˆä¾¿äºæ‰‹åŠ¨ç¼–è¾‘ç¿»è¯‘SRTï¼‰</label>
        <p class="hint">æäº¤åå¯ç›´æ¥åœ¨ä¸‹æ–¹ç¼–è¾‘æ¡†ä¸­ä¿®æ”¹ translated.srt ç„¶åç»§ç»­TTSã€‚</p>

        <div class="row">
          <div>
            <label><input id="diarization" type="checkbox" checked /> è¯´è¯äººè¯†åˆ«</label>
          </div>
          <div>
            <label><input id="separation" type="checkbox" checked /> äººå£°åˆ†ç¦»</label>
          </div>
        </div>

        <button id="submitBtn" class="btn" type="submit">å¼€å§‹å¤„ç†</button>
        <button class="btn" type="button" onclick="cancelJob()">ä¸­æ–­è¿›ç¨‹</button>
      </form>
      <div id="output" class="result" style="display:none;"></div>
      <details id="srt_box" style="display:none;">
        <summary>ç¿»è¯‘åSRTç¼–è¾‘ï¼ˆä¿å­˜åå¯ç»§ç»­TTSï¼‰</summary>
        <input id="srt_stem" type="hidden" />
        <label>translated.srt å†…å®¹</label>
        <textarea id="srt_content" placeholder="åœ¨æ­¤ç¼–è¾‘ç¿»è¯‘åçš„SRTå†…å®¹"></textarea>
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
          <button class="btn" type="button" onclick="saveSRT()">ä¿å­˜SRT</button>
          <button class="btn" type="button" onclick="continueTTS()">ç»§ç»­TTS</button>
          <div style="flex:1"></div>
        </div>
      </details>
      <div id="final_wrap" style="margin-top:12px; display:none; position:relative;">
        <label>æœ€ç»ˆè§†é¢‘é¢„è§ˆ</label>
        <video id="final_preview" controls></video>
        <div><a id="final_download" class="btn" href="#" download>ä¸‹è½½æœ€ç»ˆè§†é¢‘</a></div>
        <button type="button" class="btn" style="position:absolute; top:4px; right:4px; padding:4px 8px;" onclick="removeFinal()">Ã—</button>
      </div>
      <div id="toast" class="toast"></div>
    </div>
    
    <!-- è§†é¢‘å†å²åŒºåŸŸ -->
    <div class="card" style="margin-top: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2 style="margin: 0;">æˆ‘çš„è§†é¢‘å†å²</h2>
        <button class="btn" onclick="refreshVideoHistory()" style="padding: 6px 12px; font-size: 14px;">åˆ·æ–°</button>
      </div>
      <div id="video_history">
        <div class="hint">æ­£åœ¨åŠ è½½è§†é¢‘å†å²...</div>
      </div>
    </div>
    
    <script>
      // åŠ è½½è§†é¢‘å†å²
      async function loadVideoHistory() {
        const container = document.getElementById('video_history');
        container.innerHTML = '<div class="hint">æ­£åœ¨åŠ è½½è§†é¢‘å†å²...</div>';
        
        try {
          const res = await fetch('/videos');
          const data = await res.json();
          
          if (data.error) {
            container.innerHTML = `<div class="hint" style="color: #dc2626;">åŠ è½½å¤±è´¥: ${data.error}</div>`;
            return;
          }
          
          displayVideoHistory(data.videos || []);
        } catch (e) {
          console.error('åŠ è½½è§†é¢‘å†å²å¤±è´¥:', e);
          container.innerHTML = '<div class="hint" style="color: #dc2626;">åŠ è½½è§†é¢‘å†å²å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</div>';
        }
      }
      
      // æ‰‹åŠ¨åˆ·æ–°è§†é¢‘å†å²
      function refreshVideoHistory() {
        console.log('æ‰‹åŠ¨åˆ·æ–°è§†é¢‘å†å²');
        loadVideoHistory();
      }
      
      // å¤„ç†æ–‡ä»¶é€‰æ‹©
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) {
          CURRENT_FILE_VALID = false;
          return;
        }
        
        // ä½¿ç”¨åŠ¨æ€é™åˆ¶å€¼
        const maxSizeBytes = VIDEO_LIMITS.max_video_bytes;
        const fileSizeMB = file.size / (1024 * 1024);
        const maxSizeMB = VIDEO_LIMITS.max_video_mb;
        
        const fileInfo = document.getElementById('file_info');
        const fileStatus = document.getElementById('file_status');
        fileInfo.style.display = 'block';
        fileStatus.style.display = 'block';
        
        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (file.size > maxSizeBytes) {
          fileInfo.innerHTML = `ğŸ“ ${file.name} (${fileSizeMB.toFixed(1)}MB)`;
          fileInfo.style.color = '#6b7280';
          fileStatus.innerHTML = `âŒ æ–‡ä»¶è¿‡å¤§: ${fileSizeMB.toFixed(1)}MB > ${maxSizeMB.toFixed(1)}MB`;
          fileStatus.style.color = '#dc2626';
          CURRENT_FILE_VALID = false;
          return;
        }
        
        // æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
        fileInfo.innerHTML = `ğŸ“ ${file.name} (${fileSizeMB.toFixed(1)}MB)`;
        fileInfo.style.color = '#6b7280';
        fileStatus.innerHTML = `â³ æ£€æŸ¥æ—¶é•¿ä¸­...`;
        fileStatus.style.color = '#f59e0b';
        CURRENT_FILE_VALID = true; // æš‚æ—¶è®¾ä¸ºæœ‰æ•ˆï¼Œç­‰å¾…æ—¶é•¿æ£€æŸ¥
        
        // åˆ›å»ºè§†é¢‘é¢„è§ˆ
        const video = document.getElementById('upload_preview');
        const wrap = document.getElementById('upload_wrap');
        const url = URL.createObjectURL(file);
        video.src = url;
        wrap.style.display = 'block';
        
        // æ£€æŸ¥è§†é¢‘æ—¶é•¿
        video.onloadedmetadata = function() {
          const duration = video.duration;
          const durationMinutes = duration / 60;
          const maxMinutes = VIDEO_LIMITS.max_video_minutes;
          
          if (duration > maxMinutes * 60) {
            fileStatus.innerHTML = `âŒ æ—¶é•¿è¿‡é•¿: ${durationMinutes.toFixed(1)}åˆ†é’Ÿ > ${maxMinutes}åˆ†é’Ÿ`;
            fileStatus.style.color = '#dc2626';
            CURRENT_FILE_VALID = false;
          } else {
            fileStatus.innerHTML = `âœ… æ–‡ä»¶éªŒè¯é€šè¿‡ (${durationMinutes.toFixed(1)}åˆ†é’Ÿ)`;
            fileStatus.style.color = '#059669';
            CURRENT_FILE_VALID = true;
          }
        };
      }
      
      // æ˜¾ç¤ºè§†é¢‘å†å²
      function displayVideoHistory(videos) {
        const container = document.getElementById('video_history');
        
        if (videos.length === 0) {
          container.innerHTML = '<div class="empty-history">æš‚æ— è§†é¢‘å†å²</div>';
          return;
        }
        
        const html = videos.map(video => {
          const createDate = new Date(video.create_time * 1000).toLocaleString();
          const fileSize = formatFileSize(video.video_size);
          
          return `
            <div class="video-item">
              <h3>${video.project_id}</h3>
              <div class="video-info">
                <div>åˆ›å»ºæ—¶é—´: ${createDate}</div>
                <div>æ–‡ä»¶å¤§å°: ${fileSize}</div>
              </div>
              <video class="video-preview" controls>
                <source src="/video/${video.video_path}" type="video/mp4">
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
              </video>
              <div class="srt-links">
                ${video.srt_files.original ? `<a href="/srt?stem=${video.project_id}&user_id=${video.user_id}" target="_blank">åŸå§‹å­—å¹•</a>` : ''}
                ${video.srt_files.translated ? `<a href="/srt?stem=${video.project_id}&user_id=${video.user_id}" target="_blank">ç¿»è¯‘å­—å¹•</a>` : ''}
                ${video.srt_files.merged ? `<a href="/srt?stem=${video.project_id}&user_id=${video.user_id}" target="_blank">åˆå¹¶å­—å¹•</a>` : ''}
              </div>
              <div class="video-actions">
                <a class="btn" href="/video/${video.video_path}" download="${video.project_id}.mp4">ä¸‹è½½è§†é¢‘</a>
                <button class="btn btn-danger" onclick="deleteVideo('${video.video_path}')">åˆ é™¤</button>
              </div>
            </div>
          `;
        }).join('');
        
        container.innerHTML = html;
      }
      
      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
      
      // åˆ é™¤è§†é¢‘
      async function deleteVideo(videoPath) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè§†é¢‘é¡¹ç›®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
          return;
        }
        
        try {
          const res = await fetch(`/video/${videoPath}`, { method: 'DELETE' });
          const data = await res.json();
          
          if (data.error) {
            alert('åˆ é™¤å¤±è´¥: ' + data.error);
          } else {
            showToast('è§†é¢‘å·²åˆ é™¤');
            loadVideoHistory(); // é‡æ–°åŠ è½½åˆ—è¡¨
          }
        } catch (e) {
          console.error('åˆ é™¤è§†é¢‘å¤±è´¥:', e);
          alert('åˆ é™¤å¤±è´¥: ' + e.message);
        }
      }
      
      
      // åˆå§‹åŒ–ï¼šæ ¹æ®é»˜è®¤çš„ TTS å¼•æ“åˆ·æ–°è¯­è¨€é€‰é¡¹ä¸è¯­é€Ÿè¾“å…¥æ¡†
      onTTSEngineChange();
      (async function initWho(){ try { const res = await fetch('/whoami'); const j = await res.json(); CURRENT_USER = j.user_id; document.getElementById('user_id').textContent = CURRENT_USER || '-'; document.getElementById('queue_len').textContent = String(j.queue_len ?? 0); } catch(e) {} })();
      // æ¢å¤ä¸Šä¼ é¢„è§ˆï¼ˆä»…å¯¹é¢„è®¾æˆ–å·²ä¿å­˜çš„è·¯å¾„æœ‰æ•ˆï¼›æœ¬åœ° blob æ— æ³•è·¨åˆ·æ–°å¤ç°ï¼‰
      (function restoreUpload(){ const t = localStorage.getItem('upload_preview_type'); if (t === 'preset') { const p = localStorage.getItem('upload_preview_path'); if (p) { const v = document.getElementById('upload_preview'); const w = document.getElementById('upload_wrap'); v.src = p; w.style.display = 'block'; } } })();
      
      // åŠ è½½è§†é¢‘å†å²
      loadVideoHistory();
      
      // æ™ºèƒ½è‡ªåŠ¨åˆ·æ–°ï¼šåªåœ¨æœ‰æ´»åŠ¨ä»»åŠ¡æ—¶è‡ªåŠ¨åˆ·æ–°
      let autoRefreshTimer = null;
      let isUserActive = true; // ç”¨æˆ·æ˜¯å¦æ´»è·ƒ
      let lastActivityTime = Date.now();
      
      // æ£€æµ‹ç”¨æˆ·æ´»åŠ¨
      function updateUserActivity() {
        lastActivityTime = Date.now();
        isUserActive = true;
      }
      
      // ç›‘å¬ç”¨æˆ·æ´»åŠ¨
      ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
        document.addEventListener(event, updateUserActivity, true);
      });
      
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ´»è·ƒï¼ˆ5åˆ†é’Ÿå†…æ— æ´»åŠ¨åˆ™è®¤ä¸ºä¸æ´»è·ƒï¼‰
      function checkUserActivity() {
        const now = Date.now();
        const inactiveTime = now - lastActivityTime;
        isUserActive = inactiveTime < 5 * 60 * 1000; // 5åˆ†é’Ÿ
        
        if (!isUserActive && autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
          console.log('ç”¨æˆ·ä¸æ´»è·ƒï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°');
        } else if (isUserActive && !autoRefreshTimer && (CURRENT_JOB || document.getElementById('submitBtn').disabled)) {
          startAutoRefresh();
          console.log('ç”¨æˆ·æ´»è·ƒä¸”æœ‰æ´»åŠ¨ä»»åŠ¡ï¼Œå¼€å§‹è‡ªåŠ¨åˆ·æ–°');
        }
      }
      
      function startAutoRefresh() {
        if (autoRefreshTimer) return; // é¿å…é‡å¤å¯åŠ¨
        
        // åªæœ‰åœ¨æœ‰æ´»åŠ¨ä»»åŠ¡ä¸”ç”¨æˆ·æ´»è·ƒæ—¶æ‰è‡ªåŠ¨åˆ·æ–°
        if (CURRENT_JOB || document.getElementById('submitBtn').disabled) {
          autoRefreshTimer = setInterval(() => {
            // å†æ¬¡æ£€æŸ¥æ¡ä»¶
            if ((CURRENT_JOB || document.getElementById('submitBtn').disabled) && isUserActive) {
              console.log('è‡ªåŠ¨åˆ·æ–°è§†é¢‘å†å²');
              loadVideoHistory();
            } else {
              stopAutoRefresh();
            }
          }, 30000); // 30ç§’é—´éš”
        }
      }
      
      function stopAutoRefresh() {
        if (autoRefreshTimer) {
          clearInterval(autoRefreshTimer);
          autoRefreshTimer = null;
          console.log('åœæ­¢è‡ªåŠ¨åˆ·æ–°');
        }
      }
      
      // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡ç”¨æˆ·æ´»åŠ¨çŠ¶æ€
      setInterval(checkUserActivity, 30000);
      // æ¢å¤æœ€ç»ˆè§†é¢‘é¢„è§ˆï¼ˆè‹¥ç”¨æˆ·æœª X å…³é—­ï¼‰
      (function restoreFinal(){ const hidden = localStorage.getItem('final_hidden'); if (hidden === '1') return; const p = localStorage.getItem('final_preview_path'); if (p) { const wrap = document.getElementById('final_wrap'); const v = document.getElementById('final_preview'); const dl = document.getElementById('final_download'); v.src = p; wrap.style.display = 'block'; dl.href = p; } })();
      // ä½¿ç”¨å…¬å‘Šï¼ˆé€æ˜ç£¨ç ‚å¡ç‰‡ï¼‰
      (function renderNotice(){
        const mdLines = [
          '## å¹³å°ä»‹ç»',
          'SHIRO translate æ˜¯ä¸€ä¸ªå…¬ç›Šæ€§è´¨çš„ AI æœåŠ¡ç«™ç‚¹ã€‚',
          'ä¸´æ—¶å‰ç«¯ï¼Œå°†å°±ç”¨ã€‚',
          '## ç”¨æˆ·è´£ä»»',
          'ç”¨æˆ·å¿…é¡»æ‰¿æ‹…ä»¥ä¸‹è´£ä»»ï¼š',
          '- **åˆæ³•ä½¿ç”¨**ï¼šä»…ç”¨äºåˆæ³•åˆè§„åœºæ™¯ã€‚',
          '- **åæœè‡ªè´Ÿ**ï¼šç”±ç”¨æˆ·ä½¿ç”¨è¡Œä¸ºé€ æˆçš„æ‰€æœ‰åæœï¼Œå‡ç”±ç”¨æˆ·è‡ªè¡Œæ‰¿æ‹…ã€‚',
          '- **æ•°æ®æˆæƒï¼ˆé‡è¦è­¦å‘Šï¼‰**ï¼šæ‚¨å¿…é¡»ç¡®ä¿æ‰€ä¸Šä¼ çš„æ•°æ®æ‹¥æœ‰åˆæ³•æˆæƒã€‚ä¸¥ç¦ä½¿ç”¨ä»»ä½•æœªç»æˆæƒçš„éŸ³é¢‘æ•°æ®ã€‚å› ä½¿ç”¨éæˆæƒæ•°æ®é€ æˆçš„ç‰ˆæƒçº çº·ã€æ³•å¾‹è´£ä»»åŠå…¶ä»–ä¸€åˆ‡åæœï¼Œå‡ç”±ç”¨æˆ·æ‰¿æ‹…ï¼Œä¸æœ¬å¹³å°æ— å…³ã€‚',
          '- **åˆè§„ç”¨é€”**ï¼šæœ¬å¹³å°ä»…ä¾›ä¸ªäººå­¦ä¹ ä¸æŠ€æœ¯äº¤æµï¼Œä¸¥ç¦ç”¨äºä»»ä½•è¿æ³•çŠ¯ç½ªæˆ–æ”¿æ²»ã€å®—æ•™ç­‰æ•æ„Ÿæ´»åŠ¨ã€‚ä¸€ç»å‘ç°ï¼Œå°†ç«‹å³åœæ­¢æœåŠ¡å¹¶ä¿ç•™è¿½è´£æƒåˆ©ã€‚',
          '## å…è´£æ¡æ¬¾',
          '- æœ¬å¹³å°ä»…æä¾›æŠ€æœ¯æœåŠ¡ï¼Œä¸å‚ä¸ç”¨æˆ·çš„å…·ä½“ä½¿ç”¨è¿‡ç¨‹ã€‚',
          '- ç”¨æˆ·ä¸Šä¼ çš„æ•°æ®ã€ç”Ÿæˆçš„å†…å®¹åŠå…¶ä½¿ç”¨æ–¹å¼ï¼Œå‡ç”±ç”¨æˆ·è‡ªè¡Œè´Ÿè´£ã€‚',
          '- å› ç”¨æˆ·è¿è§„ä½¿ç”¨é€ æˆçš„ä»»ä½•é—®é¢˜ï¼Œæœ¬å¹³å°ä¸æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚',
          'ç»§ç»­ä½¿ç”¨æœ¬å¹³å°ï¼Œå³è¡¨ç¤ºæ‚¨å·²å®Œå…¨ç†è§£å¹¶åŒæ„æœ¬å…¬å‘Šçš„å…¨éƒ¨å†…å®¹ã€‚',
          '> å…¬ç›Šç«™ç‚¹ï¼Œä¸ä¿è¯ç¨³å®šï¼Œéšæ—¶è·‘è·¯ã€‚',
          'æ„Ÿè°¢æ‚¨çš„é…åˆã€‚'
        ];
        const esc = (s)=>s.replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]));
        const mdInline = (s)=> esc(s)
          .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.+?)\*/g, '<em>$1</em>')
          .replace(/`([^`]+?)`/g, '<code>$1</code>');
        let html = '';
        let inList = false;
        for (const rawLine of mdLines) {
          const line = rawLine.trim();
          if (!line) continue; // è·³è¿‡ç©ºè¡Œ
          if (line.startsWith('## ')) {
            if (inList) { html += '</ul>'; inList = false; }
            html += `<h2>${mdInline(line.slice(3))}</h2>`;
            continue;
          }
          if (line.startsWith('- ')) {
            if (!inList) { html += '<ul>'; inList = true; }
            html += `<li>${mdInline(line.slice(2))}</li>`;
            continue;
          }
          if (line.startsWith('> ')) {
            if (inList) { html += '</ul>'; inList = false; }
            html += `<p><em>${mdInline(line.slice(2))}</em></p>`;
            continue;
          }
          if (inList) { html += '</ul>'; inList = false; }
          html += `<p>${mdInline(line)}</p>`;
        }
        if (inList) html += '</ul>';
        const box = document.getElementById('notice_md');
        box.innerHTML = html;
      })();
      function onSkipTTSChange() { const checked = document.getElementById('skip_tts').checked; const box = document.getElementById('srt_box'); box.style.display = checked ? 'block' : 'none'; }
      document.getElementById('file').addEventListener('change', (e) => { const f = e.target.files[0]; if (f) { document.getElementById('srt_stem').value = deriveStemFromPath(f.name); const url = URL.createObjectURL(f); const v = document.getElementById('upload_preview'); const w = document.getElementById('upload_wrap'); v.src = url; w.style.display = 'block'; localStorage.setItem('upload_preview_type', 'blob'); localStorage.setItem('upload_preview_name', f.name); } });
      (function initPreset(){ const presetBtn = document.getElementById('preset_btn'); presetBtn.onclick = () => { document.getElementById('tts_engine').value = 'gpt-sovits'; onTTSEngineChange(); document.getElementById('transcribe_engine').value = 'whisperx'; document.getElementById('source_lang').value = 'zh'; document.getElementById('target_lang').value = 'en'; document.getElementById('skip_tts').checked = false; onSkipTTSChange(); document.getElementById('diarization').checked = true; document.getElementById('separation').checked = true; PRESET_VIDEO_PATH = 'input/ZH_test.mp4'; document.getElementById('srt_stem').value = 'ZH_test'; const v = document.getElementById('upload_preview'); const w = document.getElementById('upload_wrap'); const rel = '/input/ZH_test.mp4'; v.src = rel; w.style.display = 'block'; localStorage.setItem('upload_preview_type', 'preset'); localStorage.setItem('upload_preview_path', rel); }; })();
      function removeUpload(){ 
        const f = document.getElementById('file'); 
        f.value = ''; 
        PRESET_VIDEO_PATH = null; 
        CURRENT_FILE_VALID = false; // é‡ç½®éªŒè¯çŠ¶æ€
        const w = document.getElementById('upload_wrap'); 
        const v = document.getElementById('upload_preview'); 
        const fileInfo = document.getElementById('file_info');
        const fileStatus = document.getElementById('file_status');
        v.src=''; 
        w.style.display='none'; 
        fileInfo.style.display='none'; // éšè—æ–‡ä»¶ä¿¡æ¯
        fileStatus.style.display='none'; // éšè—çŠ¶æ€æŒ‡ç¤ºå™¨
        localStorage.removeItem('upload_preview_type'); 
        localStorage.removeItem('upload_preview_path'); 
        localStorage.removeItem('upload_preview_name'); 
      }
      function removeFinal(){ const w = document.getElementById('final_wrap'); const v = document.getElementById('final_preview'); const dl = document.getElementById('final_download'); v.src=''; dl.href='#'; w.style.display='none'; localStorage.setItem('final_hidden','1'); }
      
      // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
      function initDragDrop() {
        const dropZone = document.getElementById('drop_zone');
        const fileInput = document.getElementById('file');
        const dropText = document.getElementById('drop_text');
        
        // ç‚¹å‡»åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©
        dropZone.addEventListener('click', () => {
          fileInput.click();
        });
        
        // æ‹–æ‹½è¿›å…¥
        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.style.borderColor = '#2563eb';
          dropZone.style.backgroundColor = '#eff6ff';
          dropText.textContent = 'é‡Šæ”¾æ–‡ä»¶ä»¥ä¸Šä¼ ';
        });
        
        // æ‹–æ‹½ç¦»å¼€
        dropZone.addEventListener('dragleave', (e) => {
          e.preventDefault();
          dropZone.style.borderColor = '#d1d5db';
          dropZone.style.backgroundColor = '#f9fafb';
          dropText.textContent = 'æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶';
        });
        
        // æ‹–æ‹½é‡Šæ”¾
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.style.borderColor = '#d1d5db';
          dropZone.style.backgroundColor = '#f9fafb';
          dropText.textContent = 'æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶';
          
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            const file = files[0];
            if (file.type.startsWith('video/')) {
              // æ¨¡æ‹Ÿæ–‡ä»¶è¾“å…¥
              const dataTransfer = new DataTransfer();
              dataTransfer.items.add(file);
              fileInput.files = dataTransfer.files;
              
              // è§¦å‘æ–‡ä»¶é€‰æ‹©äº‹ä»¶
              const event = new Event('change', { bubbles: true });
              fileInput.dispatchEvent(event);
            } else {
              showToast('è¯·é€‰æ‹©è§†é¢‘æ–‡ä»¶');
            }
          }
        });
      }
      
      // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
      initDragDrop();
      
      // é¡µé¢åŠ è½½æ—¶è·å–é™åˆ¶é…ç½®
      loadVideoLimits();
    </script>
  </body>
  </html>


